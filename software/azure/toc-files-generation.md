
#!/bin/bash

# Define Root Directory Name
ROOT_DIR="Microsoft-Entra-ID-Study"

# Create Root Directory
echo "Creating root directory: $ROOT_DIR"
mkdir -p "$ROOT_DIR"
cd "$ROOT_DIR" || exit

# ==============================================================================
# PART 1: Directory Structure & Governance
# ==============================================================================
DIR_NAME="001-Directory-Structure-Governance"
echo "Creating $DIR_NAME..."
mkdir -p "$DIR_NAME"

# File 1.A
cat <<EOF > "$DIR_NAME/001-The-Identity-Store.md"
# The Identity Store (Entra ID)

*Goal: Organizing the "Source of Truth" users and groups for external mapping.*

## Key Concepts
*   **i. Users:** The atomic units. Understanding Hybrid identities (synced from on-prem AD via Azure AD Connect) vs. Cloud-only users.
*   **ii. Security Groups:** The crucial mechanism for Role Mapping. Strategy: Create specific groups (e.g., \`AWS-Production-Admins\`, \`AWS-Dev-ViewOnly\`) to map 1:1 with downstream permissions.
*   **iii. [NEW] Dynamic Memberships:** Automating group entry based on attributes (e.g., \`user.department -eq "Engineering"\` automatically adds user to \`AWS-Dev-Group\`).
EOF

# File 1.B
cat <<EOF > "$DIR_NAME/002-Enterprise-Applications.md"
# Enterprise Applications

## Key Concepts
*   **i. The Concept:** Represents the external Service Provider within the Microsoft tenant.
*   **ii. The Gallery:** Using the pre-built "AWS IAM Identity Center" Gallery App (recommended) vs. creating a "Non-Gallery" custom application.
*   **iii. [NEW] App Registration vs. Service Principal:** Understanding that the "Enterprise App" is just a local instance (Service Principal) of a global application definition.
EOF

# File 1.C
cat <<EOF > "$DIR_NAME/003-Administrative-Roles.md"
# Administrative Roles (RBAC)

## Key Concepts
*   **i. Least Privilege:** Assigning "Cloud Application Administrator" to the engineer setting this up, rather than full "Global Administrator."
EOF

# ==============================================================================
# PART 2: SSO Configuration (SAML 2.0)
# ==============================================================================
DIR_NAME="002-SSO-Configuration-SAML"
echo "Creating $DIR_NAME..."
mkdir -p "$DIR_NAME"

# File 2.A
cat <<EOF > "$DIR_NAME/001-Basic-SAML-Configuration.md"
# Basic SAML Configuration

*Goal: Establishing the Trust Relationship.*

## Key Concepts
*   **i. Identifier (Entity ID):** The unique URL provided by the SP (AWS).
*   **ii. Reply URL (Assertion Consumer Service URL):** Where Entra ID sends the authentication token.
*   **iii. [NEW] Metadata Exchange:** Utilizing the Federation Metadata XML file to auto-configure the Service Provider rather than manual entry.
EOF

# File 2.B
cat <<EOF > "$DIR_NAME/002-Attributes-and-Claims.md"
# Attributes & Claims (The Payload)

## Key Concepts
*   **i. User Identifier (NameID):** Deciding what to send as the unique key (usually \`user.userPrincipalName\` or email).
*   **ii. Group Claims:** The critical configuration to send Group Membership data inside the SAML token so the SP knows what permissions to grant.
*   **iii. Custom Claims:** Mapping specific IdP attributes (e.g., Department, Cost Center) to SAML attributes expected by the SP.
*   **iv. [NEW] Claims Transformations:** Using the "Join" or "Extract" functions to format data (e.g., stripping \`@domain.com\` from a username before sending).
EOF

# File 2.C
cat <<EOF > "$DIR_NAME/003-Signing-Certificates.md"
# Signing Certificates

## Key Concepts
*   **i. Certificate Management:** Generating, downloading (Base64), and rotating the Token Signing Certificate.
*   **ii. [NEW] Notification Email:** Configuring alerts for when the certificate is about to expire to prevent outages.
EOF

# ==============================================================================
# PART 3: Provisioning Configuration (SCIM Client)
# ==============================================================================
DIR_NAME="003-Provisioning-Configuration-SCIM"
echo "Creating $DIR_NAME..."
mkdir -p "$DIR_NAME"

# File 3.A
cat <<EOF > "$DIR_NAME/001-Admin-Credentials.md"
# Admin Credentials

*Goal: Automating the user lifecycle (Pushing data to the SP).*

## Key Concepts
*   **i. The Handshake:** Inputting the SCIM Endpoint URL and Secret Token generated by the Service Provider.
EOF

# File 3.B
cat <<EOF > "$DIR_NAME/002-Mappings-Data-Transformation.md"
# Mappings (Data Transformation)

## Key Concepts
*   **i. Attribute Mapping:** Connecting Entra ID fields (\`Run on premises extensionAttribute1\`) to SCIM fields (\`externalId\`).
*   **ii. Matching Precedence:** Defining which field links a Microsoft user to an existing AWS user (usually Email).
EOF

# File 3.C
cat <<EOF > "$DIR_NAME/003-Scoping.md"
# Scoping

## Key Concepts
*   **i. Sync Scope:** Configuring the app to only sync "Assigned Users and Groups" (preventing the accidental syncing of the entire corporate directory).
EOF

# File 3.D
cat <<EOF > "$DIR_NAME/004-Troubleshooting-Lifecycle.md"
# Troubleshooting & Lifecycle

## Key Concepts
*   **i. Provisioning Logs:** The first place to look when a user fails to appear in AWS.
*   **ii. Quarantine State:** Handling scenarios where too many errors pause the sync engine.
*   **iii. On-Demand Provisioning:** Testing a single user immediately without waiting for the 40-minute sync cycle.
EOF

# ==============================================================================
# PART 4: Security & Access Control
# ==============================================================================
DIR_NAME="004-Security-Access-Control"
echo "Creating $DIR_NAME..."
mkdir -p "$DIR_NAME"

# File 4.A
cat <<EOF > "$DIR_NAME/001-Assignment.md"
# Assignment

*Goal: Enforcing "Who" gets to log in and "How".*

## Key Concepts
*   **i. User/Group Assignment:** Explicitly adding the Security Groups defined in Section 1 to the Enterprise App.
*   **ii. [NEW] Self-Service Access:** Configuring the "My Apps" portal to allow users to *request* access to the AWS app, requiring manager approval workflow.
EOF

# File 4.B
cat <<EOF > "$DIR_NAME/002-Conditional-Access-Policies.md"
# Conditional Access Policies (CAP)

## Key Concepts
*   **i. The Perimeter:** Applying security rules specifically to this Enterprise App.
*   **ii. MFA Enforcement:** Requiring a 2nd factor (Authenticator App) specifically when accessing this application.
*   **iii. Device Compliance:** Blocking access if the request comes from an unmanaged or non-compliant device.
*   **iv. [NEW] Session Controls:** Limiting session frequency (forcing re-auth every X hours).
EOF

# ==============================================================================
# PART 5: Advanced Governance (Identity Governance)
# ==============================================================================
DIR_NAME="005-Advanced-Governance"
echo "Creating $DIR_NAME..."
mkdir -p "$DIR_NAME"

# File 5.A
cat <<EOF > "$DIR_NAME/001-Privileged-Identity-Management.md"
# Privileged Identity Management (PIM)

*Goal: Auditing and Temporary Access.*

## Key Concepts
*   **i. Just-in-Time (JIT) Access:** Users are eligible members of the "AWS-Admin-Group" but must "activate" their membership for a 4-hour window to gain access.
EOF

# File 5.B
cat <<EOF > "$DIR_NAME/002-Access-Reviews.md"
# Access Reviews

## Key Concepts
*   **i. Recertification:** Automated quarterly emails asking managers, "Does User X still need access to AWS?"
*   **ii. Auto-Remediation:** Automatically removing users who deny the review.
EOF

echo "----------------------------------------------------------------"
echo "Success! Structure created at: $(pwd)"
echo "----------------------------------------------------------------"

