# ðŸŸ¦ Microsoft Entra ID (The Identity Provider)

## 1. Directory Structure & Governance
*Goal: Organizing the "Source of Truth" users and groups for external mapping.*

*   **A. The Identity Store (Entra ID)**
    *   i. **Users:** The atomic units. Understanding Hybrid identities (synced from on-prem AD via Azure AD Connect) vs. Cloud-only users.
    *   ii. **Security Groups:** The crucial mechanism for Role Mapping. Strategy: Create specific groups (e.g., `AWS-Production-Admins`, `AWS-Dev-ViewOnly`) to map 1:1 with downstream permissions.
    *   **iii. [NEW] Dynamic Memberships:** Automating group entry based on attributes (e.g., `user.department -eq "Engineering"` automatically adds user to `AWS-Dev-Group`).
*   **B. Enterprise Applications**
    *   i. **The Concept:** Represents the external Service Provider within the Microsoft tenant.
    *   ii. **The Gallery:** Using the pre-built "AWS IAM Identity Center" Gallery App (recommended) vs. creating a "Non-Gallery" custom application.
    *   **iii. [NEW] App Registration vs. Service Principal:** Understanding that the "Enterprise App" is just a local instance (Service Principal) of a global application definition.
*   **C. [NEW] Administrative Roles (RBAC)**
    *   **i. Least Privilege:** Assigning "Cloud Application Administrator" to the engineer setting this up, rather than full "Global Administrator."

## 2. SSO Configuration (SAML 2.0)
*Goal: Establishing the Trust Relationship.*

*   **A. Basic SAML Configuration**
    *   i. **Identifier (Entity ID):** The unique URL provided by the SP (AWS).
    *   ii. **Reply URL (Assertion Consumer Service URL):** Where Entra ID sends the authentication token.
    *   **iii. [NEW] Metadata Exchange:** Utilizing the Federation Metadata XML file to auto-configure the Service Provider rather than manual entry.
*   **B. Attributes & Claims (The Payload)**
    *   i. **User Identifier (NameID):** Deciding what to send as the unique key (usually `user.userPrincipalName` or email).
    *   ii. **Group Claims:** The critical configuration to send Group Membership data inside the SAML token so the SP knows what permissions to grant.
    *   iii. **Custom Claims:** Mapping specific IdP attributes (e.g., Department, Cost Center) to SAML attributes expected by the SP.
    *   **iv. [NEW] Claims Transformations:** Using the "Join" or "Extract" functions to format data (e.g., stripping `@domain.com` from a username before sending).
*   **C. Signing Certificates**
    *   i. **Certificate Management:** Generating, downloading (Base64), and rotating the Token Signing Certificate.
    *   **ii. [NEW] Notification Email:** Configuring alerts for when the certificate is about to expire to prevent outages.

## 3. Provisioning Configuration (SCIM Client)
*Goal: Automating the user lifecycle (Pushing data to the SP).*

*   **A. Admin Credentials**
    *   i. **The Handshake:** Inputting the SCIM Endpoint URL and Secret Token generated by the Service Provider.
*   **B. Mappings (Data Transformation)**
    *   i. **Attribute Mapping:** Connecting Entra ID fields (`Run on premises extensionAttribute1`) to SCIM fields (`externalId`).
    *   ii. **Matching Precedence:** Defining which field links a Microsoft user to an existing AWS user (usually Email).
*   **C. Scoping**
    *   i. **Sync Scope:** Configuring the app to only sync "Assigned Users and Groups" (preventing the accidental syncing of the entire corporate directory).
*   **D. [NEW] Troubleshooting & Lifecycle**
    *   **i. Provisioning Logs:** The first place to look when a user fails to appear in AWS.
    *   **ii. Quarantine State:** Handling scenarios where too many errors pause the sync engine.
    *   **iii. On-Demand Provisioning:** Testing a single user immediately without waiting for the 40-minute sync cycle.

## 4. Security & Access Control
*Goal: Enforcing "Who" gets to log in and "How".*

*   **A. Assignment**
    *   i. **User/Group Assignment:** Explicitly adding the Security Groups defined in Section 1 to the Enterprise App.
    *   **ii. [NEW] Self-Service Access:** Configuring the "My Apps" portal to allow users to *request* access to the AWS app, requiring manager approval workflow.
*   **B. Conditional Access Policies (CAP)**
    *   i. **The Perimeter:** Applying security rules specifically to this Enterprise App.
    *   ii. **MFA Enforcement:** Requiring a 2nd factor (Authenticator App) specifically when accessing this application.
    *   iii. **Device Compliance:** Blocking access if the request comes from an unmanaged or non-compliant device.
    *   **iv. [NEW] Session Controls:** Limiting session frequency (forcing re-auth every X hours).

## 5. [NEW] Advanced Governance (Identity Governance)
*Goal: Auditing and Temporary Access.*

*   **A. Privileged Identity Management (PIM)**
    *   i. **Just-in-Time (JIT) Access:** Users are eligible members of the "AWS-Admin-Group" but must "activate" their membership for a 4-hour window to gain access.
*   **B. Access Reviews**
    *   i. **Recertification:** Automated quarterly emails asking managers, "Does User X still need access to AWS?"
    *   ii. **Auto-Remediation:** Automatically removing users who deny the review.