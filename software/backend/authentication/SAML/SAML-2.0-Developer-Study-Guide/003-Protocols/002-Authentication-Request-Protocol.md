Based on the Table of Contents you provided, section **13. Authentication Request Protocol** covers the **`AuthnRequest`**, which is the single most important message in a Service Provider-Initiated (SP-Initiated) Single Sign-On flow.

Here is a detailed detailed explanation of exactly what that part covers:

---

# 13. Authentication Request Protocol (`AuthnRequest`)

The `AuthnRequest` is an XML message sent from the **Service Provider (SP)** (e.g., Slack, Salesforce, or your custom app) to the **Identity Provider (IdP)** (e.g., Okta, Azure AD). Its purpose is to ask the IdP to authenticate a user.

### 1. `AuthnRequest` Structure
The request is an XML document usually wrapped in the `<samlp:AuthnRequest>` tag (where `samlp` stands for SAML Protocol). It must contain specific attributes to tell the IdP who is asking and what they want.

**Basic XML Skeleton:**
```xml
<samlp:AuthnRequest
    ID="_random_generated_id"
    Version="2.0"
    IssueInstant="2023-10-27T10:00:00Z"
    Destination="https://idp.example.com/sso"
    ...>
    <saml:Issuer>https://sp.myapp.com/metadata</saml:Issuer>
    <!-- Other parameters -->
</samlp:AuthnRequest>
```

---

### 2. Request Parameters (XML Attributes)
These are attributes found inside the opening `<samlp:AuthnRequest ...>` tag. They dictate the behavior of the login process.

#### **`ID`**
*   **What it is:** A unique string generated by the SP (e.g., `_a75ad...`).
*   **Purpose:** It allows the SP to correlate the eventual response with this specific request. When the IdP answers, it will say `InResponseTo="_a75ad..."`.
*   **Rule:** It must start with a character (not a number) and must be unique per message.

#### **`IssueInstant`**
*   **What it is:** A timestamp (UTC) indicating when the request was generated.
*   **Purpose:** Security. The IdP checks this to ensure the request isn't too old (preventing replay attacks).

#### **`Destination`**
*   **What it is:** The URL of the IdP where this message is being sent.
*   **Purpose:** Security. It prevents an attacker from redirecting a request intended for "IdP A" to "IdP B". The IdP verifies that the URL matches its own address.

#### **`AssertionConsumerServiceURL` (ACS URL)**
*   **What it is:** The callback URL on the SP side.
*   **Purpose:** It tells the IdP: "If the login is successful, please post the valid token (Assertion) to *this specific URL*."
*   **Note:** This URL must usually match what is pre-configured in the IdP's settings for that app.

#### **`ProtocolBinding`**
*   **What it is:** A URI indicating *how* the SP wants the response delivered.
*   **Common Value:** `urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST`.
*   **Translation:** "Please send the response back as an HTML Form POST."

#### **`IsPassive`** (Boolean: true/false)
*   **What it is:** A flag that controls user interaction.
*   **If `true`:** The IdP is **not allowed** to show a login screen or interact with the user.
*   **Use Case:** The SP wants to check if the user is *already* logged into the IdP. If they are, the IdP sends a success token instantly. If they aren't, the IdP sends back an error immediately without prompting for a password.

#### **`ForceAuthn`** (Boolean: true/false)
*   **What it is:** A flag that forces a fresh login.
*   **If `true`:** The IdP must ask the user for their credentials again, even if the user already has an active session.
*   **Use Case:** Highly sensitive actions (e.g., transferring money, viewing salary data) where you want to ensure the person sitting at the computer is actually the user, not someone using an unlocked computer.

---

### 3. `NameIDPolicy` (Child Element)
This XML element tells the IdP what format the SP wants the username (Subject) to be in.

```xml
<samlp:NameIDPolicy
    Format="urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress"
    AllowCreate="true" />
```

*   **Format:** e.g., "Email Address" or "Persistent ID". If the SP relies on email to identify users, it requests `emailAddress`.
*   **AllowCreate:** asking the IdP to create a new identifier if one doesn't exist for this user map (mostly used with Persistent IDs).

---

### 4. `RequestedAuthnContext` (Child Element)
This allows the SP to demand a specific *type* or *level* of security for the authentication.

```xml
<samlp:RequestedAuthnContext Comparison="exact">
    <saml:AuthnContextClassRef>
        urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport
    </saml:AuthnContextClassRef>
</samlp:RequestedAuthnContext>
```

*   **AuthnContextClassRef:** This URI represents the mechanism.
    *   `PasswordProtectedTransport`: Standard Username/Password over HTTPS.
    *   `X509`: Smart card / Certificate.
    *   `TimeSyncToken`: MFA (like an RSA key).
*   **Comparison:**
    *   `exact`: "I need exactly this method."
    *   `minimum`: "I need this method or something more secure."

---

### 5. Scoping & IdP Discovery
This is an advanced element used primarily in **Federation (Proxy)** scenarios.

Imagine an SP connects to a "Broker IdP," which connects to 50 real Universities.

*   **`IDPList`:** The SP can list exactly which University (IdP) the user should authenticate with, bypassing the manual selection screen at the Broker.
*   **`ProxyCount`:** Limits how many times the request can be hopped/proxied to other IdPs (to prevent infinite loops).

---

### Summary Table for Developers

| Element/Attribute | Required? | Why is it crucial? |
| :--- | :--- | :--- |
| **Issuer** | **Yes** | Tells the IdP which App is calling (Entity ID). |
| **ID** | **Yes** | Used to match the Request to the Response later. |
| **IssueInstant** | **Yes** | Prevents replay attacks; time sensitivity. |
| **ACS URL** | Optional* | Tells IdP where to send the token. (*If omitted, IdP uses the default in metadata). |
| **ForceAuthn** | No | Used mainly for high-security transaction portals. |
| **NameIDPolicy** | No | Ensures user ID format matches your database (e.g., email vs uuid). |
