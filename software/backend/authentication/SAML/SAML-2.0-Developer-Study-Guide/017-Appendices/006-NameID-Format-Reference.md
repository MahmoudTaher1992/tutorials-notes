Based on the file path **`017-Appendices/006-NameID-Format-Reference.md`** and the context of the study guide, this section provides a technical compatibility reference for how users are identified in SAML assertions.

In SAML, the **NameID** (Name Identifier) is the specific string used to assert *who* the user is. The **NameID Format** tells the Service Provider (SP) how to interpret that string.

Here is a detailed explanation of this appendix content, broken down by format type, usage, and XML representation.

---

# Appendix F: NameID Format Reference

## 1. What is the NameID Element?

Inside a SAML Assertion, the `<Subject>` element contains a `<NameID>`. This is the primary key linking the user at the Identity Provider (IdP) to the user account at the Service Provider (SP).

**XML Structure:**
```xml
<saml:Subject>
    <saml:NameID Format="urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress">
        jane.doe@example.com
    </saml:NameID>
</saml:Subject>
```

The `Format` attribute is a URI constant that defines the data type and processing rules for the value inside the tag.

---

## 2. Common NameID Formats

These are the standard formats defined in the SAML 2.0 Core specification.

### A. Email Address
*   **URI:** `urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress`
*   **Description:** The content must be a valid email address (RFC 2822).
*   **Use Case:** The most common format for SaaS applications (Salesforce, Slack, Zoom). It is easy for humans to read and easy to map to user accounts.
*   **Pros:** Simple; human-readable.
*   **Cons:** Email addresses can change (e.g., marriage, name change), which can break the link to the user account history. It also exposes PII (Personally Identifiable Information).

### B. Unspecified
*   **URI:** `urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified`
*   **Description:** The interpretation of the ID is left to the discretion of the implementation. It basically means "We agreed on this format out-of-band (manually)."
*   **Use Case:** Often used as a default by legacy IdPs (like ADFS) or when sending a username, employee ID, or a custom database ID.
*   **Risk:** Because it is "unspecified," one IdP might send an email while another sends a numeric ID, leading to integration breaks if not strictly documented.

### C. Persistent (Opaque)
*   **URI:** `urn:oasis:names:tc:SAML:2.0:nameid-format:persistent`
*   **Description:** A random, unique identifier generated by the IdP for a specific user at a specific SP.
    *   Example: `AAd71...991a`
*   **Use Case:** High-security or privacy-focused environments. Used when you want to link accounts without revealing the user's actual username or email.
*   **Behavor:**
    *   **Persistent:** If the user logs in tomorrow, they get the *exact same* random string.
    *   **Pairwise:** If the user logs into App A and App B, they get *different* random strings for each app (preventing cross-app tracking).

### D. Transient (Temporary)
*   **URI:** `urn:oasis:names:tc:SAML:2.0:nameid-format:transient`
*   **Description:** A random identifier that changes every single time the user logs in.
*   **Use Case:** Anonymous sessions or "One-time" access.
*   **Scenario:** A library gives a user access to a scholarly database. The database knows the user is valid (authenticated by the library) but doesn't know *who* they are and cannot save user preferences or history.

### E. X.509 Subject Name
*   **URI:** `urn:oasis:names:tc:SAML:1.1:nameid-format:X509SubjectName`
*   **Description:** The value is the Distinguished Name (DN) from an X.509 certificate.
*   **Example:** `CN=Jane Doe, OU=Engineering, O=Example Corp, C=US`
*   **Use Case:** Environments using Smart Cards (PIV/CAC) or mutual TLS authentication where the identity is tied to a client certificate.

### F. Windows Domain Qualified Name
*   **URI:** `urn:oasis:names:tc:SAML:1.1:nameid-format:WindowsDomainQualifiedName`
*   **Description:** Identifies a user in a Windows environment, usually in the format `Domain\UserName`.
*   **Example:** `CORP\jdoe`
*   **Use Case:** Intranet applications integrated with Active Directory.

### G. Kerberos Principal Name
*   **URI:** `urn:oasis:names:tc:SAML:2.0:nameid-format:kerberos`
*   **Description:** The format follows the Kerberos specification (`user@REALM`).
*   **Example:** `jdoe@CORP.EXAMPLE.COM`
*   **Use Case:** Environments heavily relying on Kerberos ticketing systems alongside SAML.

### H. Entity Identifier
*   **URI:** `urn:oasis:names:tc:SAML:2.0:nameid-format:entity`
*   **Description:** Used when the subject is not a human user, but a system entity (like an IdP or SP itself). The value is usually the EntityID URL.
*   **Use Case:** Administrative messages or metadata exchanges, not usually for user login.

---

## 3. Comparison Table

| Format Name | Privacy Level | Permanence | Typical Value | Best Used For |
| :--- | :--- | :--- | :--- | :--- |
| **EmailAddress** | Low | Low (Emails change) | `bob@company.com` | Standard Web SaaS apps |
| **Unspecified** | N/A | Variable | `bob123` or `10045` | Legacy systems, Employee IDs |
| **Persistent** | High | High | `8f9d3a2...` | Privacy-compliant federation |
| **Transient** | Ultra-High | None (Session only) | `_1a2b3c...` | Anonymous access, public portals |
| **Windows** | Low | Medium | `DOMAIN\bob` | Internal corporate apps |

---

## 4. Implementation Notes for Developers

### How to choose?
1.  **Check the SP Documentation:** Most Service Providers explicitly state which format they require. E.g., "We require `emailAddress` as the NameID."
2.  **Metadata Negotiation:** The SP Metadata usually lists supported formats:
    ```xml
    <NameIDFormat>urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress</NameIDFormat>
    <NameIDFormat>urn:oasis:names:tc:SAML:2.0:nameid-format:persistent</NameIDFormat>
    ```
    The IdP picks the best match from this list.

### Common Error: "Format Mismatch"
If an SP expects an Email Address but receives a check for `urn:oasis:names:tc:SAML:2.0:nameid-format:transient`, the application will usually crash or reject the login because it cannot map the random string `_abc123` to the user account `bob@company.com` in its database.
